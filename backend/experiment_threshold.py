import numpy as np
from sentence_transformers import SentenceTransformer
from sklearn.metrics.pairwise import cosine_similarity

# 1. 모델 로드
print("⏳ 모델 로딩 중... (잠시만 기다려 주세요)")
model = SentenceTransformer('snunlp/KR-SBERT-V40K-klueNLI-augSTS')

# 2. 점수 계산 함수 (Max, Mean, Top3)
def calc_scores(list_a, list_b):
    embeddings_a = model.encode(list_a)
    embeddings_b = model.encode(list_b)
    
    all_scores = []
    for vec_a in embeddings_a:
        for vec_b in embeddings_b:
            sim = cosine_similarity([vec_a], [vec_b])[0][0]
            all_scores.append(sim)
            
    all_scores.sort(reverse=True)
    
    _max = all_scores[0]
    _mean = sum(all_scores) / len(all_scores)
    # Top 3가 안 되면 전체 평균 사용
    _top3 = sum(all_scores[:3]) / 3 if len(all_scores) >= 3 else _mean
    
    return _max, _mean, _top3

# -------------------------------------------------------
# 3. 실험 데이터 (30개 케이스)
# -------------------------------------------------------
cases = [
    # === GROUP A: Strong (0~9) ===
    (["인공지능은 인간의 지능을 기계로 구현한 것이다."], ["알파고는 딥러닝을 통해 바둑을 학습한 대표적인 인공지능이다."]),
    (["지구 온난화로 인해 해수면이 상승하고 있다."], ["투발루 같은 섬나라들은 국토가 물에 잠길 위기에 처했다."]),
    (["매일 30분 이상의 유산소 운동은 필수적이다."], ["달리기는 심폐 지구력을 강화하고 심장병 위험을 낮춘다."]),
    (["청년 실업률이 역대 최고치를 기록했다."], ["정부는 청년 고용 기업에 세제 혜택을 주는 정책을 발표했다."]),
    (["창의적인 교육 방식이 필요하다."], ["주입식 암기보다는 토론과 프로젝트 위주의 수업이 확대되어야 한다."]),
    (["모든 사람은 죽는다."], ["소크라테스는 사람이므로 언젠가 죽는다."]),
    (["블록체인은 데이터의 위변조를 막는 기술이다."], ["가상화폐뿐만 아니라 전자 투표 시스템에도 블록체인이 활용된다."]),
    (["최근 1인 가구가 급격히 증가하고 있다."], ["결혼에 대한 가치관 변화와 고령화가 주된 원인으로 꼽힌다."]),
    (["정부는 일회용 컵 보증금 제도를 시행했다."], ["하지만 회수 인프라가 부족하여 시민들의 불편이 가중되고 있다."]),
    (["우리는 탄소 중립을 2050년까지 달성해야 한다."], ["이를 위해 화석 연료 사용을 줄이고 재생 에너지를 늘려야 한다."]),

    # === GROUP B: Bridge (10~19) ===
    (["코로나19 이후 원격 근무가 보편화되었다."], ["최근 도심 상업용 부동산의 공실률이 높아지고 있다."]),
    (["나는 오늘 커피를 다섯 잔이나 마셨다."], ["내일 아침 일찍 일어나야 하는데 걱정이다."]),
    (["청소년들의 스마트폰 사용 시간이 늘고 있다."], ["서점들이 하나둘씩 문을 닫고 있다."]),
    (["전기차 전환이 가속화되고 있다."], ["엔진 부품을 만드는 공장 노동자들이 시위를 하고 있다."]),
    (["인스타그램에는 행복해 보이는 사진만 올라온다."], ["최근 20대 우울증 환자가 급증했다는 통계가 있다."]),
    (["동네마다 편의점이 없는 곳이 없다."], ["소포장 과일이나 간편식 매출이 크게 늘었다."]),
    (["출산율이 0.7명대로 떨어졌다."], ["군 복무 기간을 늘려야 한다는 주장이 나오고 있다."]),
    (["생성형 AI가 그림을 1초 만에 그려준다."], ["많은 웹툰 작가들이 저작권 소송을 준비 중이다."]),
    (["한때 메타버스가 세상을 바꿀 것이라 했다."], ["요즘은 챗GPT 같은 텍스트 AI가 더 인기다."]),
    (["미국 연준이 기준 금리를 인상했다."], ["어제 코스피 지수가 2% 넘게 폭락했다."]),

    # === GROUP C: Weak (20~29) ===
    (["사과는 맛있는 과일이다."], ["사과는 맛없는 과일이다."]),
    (["운동을 하면 근육이 생긴다."], ["나는 어제 피자를 먹었다."]),
    (["오늘 날씨가 매우 맑고 화창하다."], ["삼성전자 주식을 사야 할 타이밍이다."]),
    (["인공지능(AI) 기술이 발전하고 있다."], ["AI(조류 독감)로 인해 닭들이 살처분되고 있다."]),
    (["책을 많이 읽으면 지식이 쌓인다."], ["따라서 책을 읽으면 키가 클 것이다."]),
    (["아인슈타인은 천재 물리학자다."], ["그러므로 아인슈타인이 좋아하는 요리는 세계 최고의 요리다."]),
    (["나는 세금을 내는 것이 너무 아깝다."], ["국가는 모든 복지 정책을 폐지해야 한다."]),
    (["공룡은 6천만 년 전에 멸종했다."], ["스마트폰 배터리가 너무 빨리 닳는다."]),
    (["내 친구는 수학을 못한다."], ["모든 한국 사람은 수학을 못하는 것이 분명하다."]),
    (["비가 오면 땅이 젖는다."], ["땅이 젖어 있는 이유는 비가 왔기 때문이다."])
]

# -------------------------------------------------------
# 4. 통계 집계 변수 초기화
# -------------------------------------------------------
stats = {
    "Strong": {"max": [], "mean": [], "top3": []},
    "Bridge": {"max": [], "mean": [], "top3": []},
    "Weak":   {"max": [], "mean": [], "top3": []}
}

# -------------------------------------------------------
# 5. 실행 및 그룹별 데이터 수집
# -------------------------------------------------------
print("\n[개별 케이스 분석 결과]")
print("-" * 70)
print(f"{'ID':<4} | {'Group':<8} | {'Max':<6} | {'Mean':<6} | {'Top3':<6} | Summary")
print("-" * 70)

for i, (parent, child) in enumerate(cases):
    # 점수 계산
    max_s, mean_s, top3_s = calc_scores(parent, child)
    
    # 그룹 판별
    if i < 10: group = "Strong"
    elif i < 20: group = "Bridge"
    else: group = "Weak"
    
    # 통계 수집
    stats[group]["max"].append(max_s)
    stats[group]["mean"].append(mean_s)
    stats[group]["top3"].append(top3_s)
    
    # 개별 출력
    print(f"{i+1:<4} | {group:<8} | {max_s:.3f}  | {mean_s:.3f}  | {top3_s:.3f}  | {parent[0][:10]}... -> {child[0][:10]}...")

# -------------------------------------------------------
# 6. 최종 통계 결과 출력 (평균 계산)
# -------------------------------------------------------
print("\n" + "="*60)
print("📊 [그룹별 평균 점수 요약 (Statistics Summary)]")
print("="*60)
print(f"{'Group':<10} | {'Avg Max':<10} | {'Avg Mean':<10} | {'Avg Top3':<10}")
print("-" * 60)

for group_name in ["Strong", "Bridge", "Weak"]:
    data = stats[group_name]
    
    # 평균 계산
    avg_max = sum(data["max"]) / len(data["max"])
    avg_mean = sum(data["mean"]) / len(data["mean"])
    avg_top3 = sum(data["top3"]) / len(data["top3"])
    
    print(f"{group_name:<10} | {avg_max:.4f}     | {avg_mean:.4f}     | {avg_top3:.4f}")

print("-" * 60)
print("👉 Tip: 'Weak' 그룹의 Avg Top3 점수와 'Bridge' 그룹의 Avg Top3 점수 사이로")
print("        임계값(Threshold)을 설정하는 것이 가장 좋습니다.")
print("="*60)