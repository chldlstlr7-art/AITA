import os
import json
from services.deep_analysis_service import perform_deep_analysis

# ----------------------------------------------------------------
# 1. 환경 변수 설정 (테스트용)
# ----------------------------------------------------------------
# 실제 API 키를 입력하거나, 시스템 환경변수에 이미 설정되어 있어야 합니다.
if not os.environ.get('GEMINI_API_KEY'):
    # os.environ['GEMINI_API_KEY'] = "여기에_실제_API_KEY_입력"
    print("⚠️ 경고: GEMINI_API_KEY가 환경변수에 없습니다. LLM 기능이 작동하지 않을 수 있습니다.")

# ----------------------------------------------------------------
# 2. 테스트용 Mock Data (가짜 데이터) 생성
# ----------------------------------------------------------------

# 상황: 학생이 "원격 근무"에 대해 썼는데, 일부 논리가 빈약하고(모호함), 
# '부동산 비용'이라는 키워드는 언급만 하고 본문에서 연결하지 않음(고립).

TEST_TEXT = "조기 전공 확정 시스템, 청년 세대의 진로 불안을 키우는 근본 원인\r\n현재 한국 대학의 조기 전공 확정 시스템은 학생들의 건전한 진로 탐색을 방해하고, 장기적인 진로 불안을 심화시키는 구조적 모순을 내포하고 있습니다. 전공이 곧 개인의 사회적 지위와 미래를 상징하는 강력한 표식이 되면서, 학생들은 초기 선택의 실패가 곧 인생의 실패로 이어질 것이라는 극심한 압박감 속에 놓이게 됩니다. 저는 이러한 '조기 확정' 방식이 본질적인 진로 탐색을 왜곡한다고 주장합니다.\r\n1. :돋보기: 정보 비대칭성이 낳는 '선택 후회(Post-choice Regret)'\r\n고등학교 졸업 직후 또는 대학 신입생이 불완전한 정보만으로 4년 후의 산업 동향과 자신의 적성을 정확히 예측하여 최적의 전공을 선택하는 것은 현실적으로 불가능합니다. 학생들은 주로 취업률 통계나 파편적인 경험담에 의존하며, 이러한 제한된 정보에 기반한 결정은 필연적으로 대학 재학 중 **'선택 후회'**를 유발합니다.\r\n경험적 증거: \"다시 대학에 간다면 전공을 바꾸고 싶다\"는 대규모 설문조사 결과는 현행 조기 확정 시스템의 실패를 명확하게 보여주는 지표입니다.\r\n2. :방패: 경직된 시스템이 저해하는 '자기 효능감'과 능동적 진로 인식\r\n대학의 폐쇄적인 전공 변경 및 융합 교육 환경은 학생들의 자기 효능감 발달을 저해하고 진로를 수동적으로 인식하게 만듭니다.\r\n역량의 한계 설정: 학생들은 자신이 선택한 전공을 자신의 잠재적 역량의 한계로 간주하며, 전공 외 분야 탐색이나 새로운 기술 습득의 기회를 스스로 차단하게 됩니다.\r\n미래에 대한 통제력 상실: 급변하는 노동 시장에서 능동적으로 대처하기보다는 시스템이 정해준 길에 의존하려는 경향은 미래에 대한 심각한 통제력 상실과 불안감을 유발하는 치명적인 약점으로 작용합니다.\r\n:전구: 혁신 방향: 유연하고 지속적인 진로 탐색의 장으로\r\n따라서 대학은 전공을 단순히 지식 습득의 수단이 아닌, 지속적인 자기 탐색의 장으로 인식하도록 시스템을 혁신해야 합니다.\r\n무전공 입학 및 전공 자유 이수제: 학생들이 2~3학년에 이르러 최종 전공을 확정하도록 하는 **'전공 선택 유연화 방안'**을 적극적으로 도입해야 합니다.\r\n의무적 진로 지도: 학부 전반에 걸친 광범위한 진로 지도를 의무화하여, 학생들이 충분한 정보를 바탕으로 주도적인 선택을 할 수 있도록 지원해야 합니다.\r\n이러한 근본적인 시스템의 변화만이 전공 선택이 청년들의 진로 불안을 가중시키는 굴레에서 벗어나도록 만들 수 있습니다."
# 1단계 분석 결과라고 가정하는 Mock JSON
TEST_SUMMARY_JSON ={
    "Claim": "조기 전공 확정 시스템으로 인한 청년 세대의 진로 불안을 해소하기 위해서는 무전공 입학 및 전공 자유 이수제 도입과 의무적 진로 지도 강화를 통해 유연하고 지속적인 진로 탐색의 장을 마련하는 근본적인 시스템 변화가 필수적입니다.",
    "Conclusion_Framing": "결론은 청년 세대의 진로 불안을 해소하기 위한 유일한 방법으로 '근본적인 시스템 변화'의 필요성을 강조하며, 이러한 변화만이 긍정적인 미래를 가져올 수 있다는 정책 제언적이자 미래 지향적인 어조로 마무리됩니다.",
    "Core_Thesis": "한국 대학의 조기 전공 확정 시스템은 청년 세대의 진로 불안을 심화시키고 진로 탐색을 왜곡하므로, 전공 선택 유연화 방안(무전공 입학, 전공 자유 이수제) 도입 및 의무적 진로 지도 강화를 통해 근본적인 시스템 변화를 이루어야 한다.",
    "Flow_Pattern": {
      "edges": [
        [
          "P1",
          "T1"
        ],
        [
          "T1",
          "R1"
        ],
        [
          "R1",
          "E1"
        ],
        [
          "T1",
          "R2"
        ],
        [
          "T1",
          "C1"
        ],
        [
          "R1",
          "C1"
        ],
        [
          "R2",
          "C1"
        ]
      ],
      "nodes": {
        "C1": "[결론]\n 근본적인 시스템의 변화만이 전공 선택이 청년들의 진로 불안을 가중시키는 굴레에서 벗어나도록 만들 수 있다.",
        "E1": "[세부 예시]\n '다시 대학에 간다면 전공을 바꾸고 싶다'는 대규모 설문조사 결과.",
        "P1": "[문제 제기]\n 한국 대학의 조기 전공 확정 시스템이 진로 탐색 방해 및 진로 불안 심화의 근본 원인이다.",
        "R1": "[근거]\n 불완전한 정보로 인한 조기 전공 확정은 '선택 후회'를 유발한다.",
        "R2": "[근거]\n 경직된 시스템은 학생들의 '자기 효능감' 발달 및 능동적 진로 인식을 저해하고 미래에 대한 통제력 상실을 야기한다.",
        "T1": "[핵심 주장]\n 조기 전공 확정 시스템으로 인한 청년 세대의 진로 불안을 해소하기 위해 전공 선택 유연화(무전공 입학, 전공 자유 이수제) 및 의무적 진로 지도를 통한 근본적인 시스템 변화가 필요하다."
      }
    },
    "Problem_Framing": "서론에서 현재 조기 전공 확정 시스템이 학생들의 건전한 진로 탐색을 방해하고 장기적인 진로 불안을 심화시키는 구조적 모순을 내포하고 있음을 지적하며 문제를 제기합니다. 전공이 곧 개인의 미래를 상징하는 강력한 표식이 되어 극심한 압박감을 유발하며, 이러한 '조기 확정' 방식이 본질적인 진로 탐색을 왜곡한다는 필자의 주장을 직접적으로 제시하는 방식으로 전개됩니다.",
    "Reasoning_Logic": "글은 현재 조기 전공 확정 시스템의 구조적 문제점을 제시하며 시작합니다. 첫 번째 근거로 정보 비대칭성으로 인한 '선택 후회' 발생을 주장하며, 이를 '다시 대학에 간다면 전공을 바꾸고 싶다'는 대규모 설문조사 결과라는 경험적 증거로 뒷받침합니다. 두 번째 근거로는 경직된 시스템이 '자기 효능감' 발달과 능동적 진로 인식을 저해하고 미래에 대한 통제력 상실을 야기한다는 논리를 펼칩니다. 이러한 문제점들을 바탕으로 마지막 단락에서 '유연하고 지속적인 진로 탐색의 장'을 위한 구체적인 혁신 방향(무전공 입학, 전공 자유 이수제, 의무적 진로 지도)을 제시하며 시스템 변화의 필요성을 강조하는 전형적인 문제-원인-해결책 구조의 설득적 논리 전개를 보입니다.",
    "Specific_Evidence": "본문에는 '선택 후회(Post-choice Regret)'라는 특정 개념, '다시 대학에 간다면 전공을 바꾸고 싶다'는 대규모 설문조사 결과(구체적인 출처는 제시되지 않음), '자기 효능감'이라는 심리학적 개념, 그리고 해결책으로 '무전공 입학 및 전공 자유 이수제', '전공 선택 유연화 방안'과 같은 구체적인 정책/제도 명칭이 언급됩니다.",
    "assignment_type": "논설문",
    "key_concepts": "조기 전공 확정 시스템, 진로 불안, 선택 후회, 정보 비대칭성, 자기 효능감, 전공 선택 유연화, 의무적 진로 지도"
  }

# ----------------------------------------------------------------
# 3. 테스트 실행 함수
# ----------------------------------------------------------------

def run_test():
    print("🧪 [Test Start] Deep Analysis (Zone Logic & Naver API) 테스트\n")

    try:
        # 서비스 호출
        result = perform_deep_analysis_async(TEST_SUMMARY_JSON, TEST_TEXT)
        
        print("\n" + "="*70)
        print("✅ [최종 분석 결과 리포트]")
        print("="*70)

        # 1. 논리 뉴런 맵
        print("\n1. 🧠 논리 뉴런 맵 (Logic Neuron Map)")
        neuron_map = result.get('neuron_map', {})
        
        print(f"   [노드 & 엣지]")
        for edge in neuron_map.get('edges', []):
            # 엣지 타입에 따라 이모지 다르게 표시
            icon = "🔗"
            if edge.get('type') == 'strong': icon = "💪"
            elif edge.get('type') == 'questionable': icon = "❓(Zone C)"
            
            print(f"     {icon} {edge['source']} <--> {edge['target']} (강도: {edge['weight']}, 타입: {edge.get('type')})")

        print(f"\n   [🎨 Zone C 창의성 검증 결과]")
        creatives = neuron_map.get('creative_feedbacks', [])
        if creatives:
            for cf in creatives:
                judgment = cf.get('judgment', 'Unsure')
                icon = "💡" if judgment == "Creative" else "🤔"
                print(f"     {icon} 판정: {judgment} ({cf['concepts'][0]} - {cf['concepts'][1]})")
                print(f"       └ 이유: {cf.get('reason')}")
                print(f"       └ 피드백: {cf.get('feedback')}")
        else:
            print("     - 감지된 Zone C 연결 없음")

        print(f"\n   [🌉 Zone B 기반 Bridge 제안]")
        suggestions = neuron_map.get('suggestions', [])
        if suggestions:
            for s in suggestions:
                print(f"     Subject: '{s['target_node']}' <--> '{s['partner_node']}'")
                # JSON 구조에 따라 socratic_guide 위치 확인
                guide = s['suggestion'].get('socratic_guide', '내용 없음')
                print(f"       └ 멘토링: {guide}")
        else:
            print("     - 제안할 Bridge 없음")

        # 2. 논리 정합성
        print("\n2. 🛡️ 논리 정합성 스캐너 (Integrity Scanner)")
        issues = result.get('integrity_issues', [])
        if issues:
            for i, issue in enumerate(issues):
                print(f"   [{i+1}] 유형: {issue.get('type')}")
                print(f"       - 문장: \"{issue.get('quote')}\"")
                print(f"       - 멘토링: {issue.get('socratic_suggestion')}")
        else:
            print("   - 감지된 문제 없음")

        # 3. 흐름 단절
        print("\n3. 🌊 흐름 단절 확인 (Flow Disconnects)")
        disconnects = result.get('flow_disconnects', [])
        if disconnects:
            for d in disconnects:
                print(f"   ⚠️ [{d.get('issue_type')}] {d.get('parent_id')} -> {d.get('child_id')} (점수: {d.get('score')})")
                print(f"      - 진단: {d.get('reason')}")
                print(f"      - 제안: {d.get('suggestion')}")
        else:
            print("   - 모든 논리 흐름이 튼튼함")

        print("\n" + "="*70)

    except Exception as e:
        print(f"\n❌ 테스트 중 에러 발생: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    run_test()