import re

# ============================================================
# 1. 테스트 대상 함수 (개선된 버전)
# ============================================================
def _parse_comparison_scores(report_text):
    # 1. 점수 컨테이너 초기화
    scores = {
        "Core Thesis Similarity": 0, 
        "Problem Framing Similarity": 0, 
        "Claim Similarity": 0,
        "Reasoning Similarity": 0, 
        "Flow Pattern Similarity": 0, 
        "Conclusion Framing Similarity": 0,
    }
    
    parsed_count = 0
    
    try:
        # 2. 파싱 로직 (강력한 Regex 적용)
        for key_name in scores.keys():
            # [Regex 설명]
            # re.escape(key_name) : 키워드 매칭
            # .*?                 : 중간에 잡다한 문자 비탐욕적 허용
            # :                   : 콜론 필수
            # [\s\*]* : 공백이나 별표(*)가 0개 이상 섞여 있어도 무시
            # (\d+)               : 숫자 추출
            pattern = rf"{re.escape(key_name)}.*?:\s*[\s\*]*(\d+)"
            
            match = re.search(pattern, report_text, re.IGNORECASE)
            if match:
                score = int(match.group(1))
                scores[key_name] = score
                parsed_count += 1
            else:
                print(f"[_parse_comparison_scores] Warning: Could not find score for '{key_name}'")

        # 3. [수정] 가중치 적용하여 총점 계산
        # 기본 총합(sum)에 'Reasoning Similarity'를 한 번 더 더해주면 2배 가중치가 됩니다.
        # (Reasoning은 중요하므로 x2)
        
        final_score = sum(scores.values()) + scores["Reasoning Similarity"]

    except Exception as e:
        print(f"[_parse_comparison_scores] Parsing Error: {e}")
        return 0, scores
    
    return final_score, scores

# ============================================================
# 2. 테스트 케이스 정의
# ============================================================

# Case 1: 표준 포맷 (하이픈 포함)
text_standard = """
이 두 보고서는 단순히 유사한 주제를 다루는 것을 넘어, 문제 정의, 핵심 주장, 주장을 뒷받침하는 세 가지 주요 논거의 전개 방식, 그리고 결론부의 수사적 전략에 이르기까지 **거의 동일한 논리적 건축물**을 공유하고 있습니다. 특히 문제 상황을 설명하는 핵심 개념들("딥페이크", "확증 편향")과 비판적 사고력 교육의 효과를 설명하는 논거들(개인의 합리적 판단 능력, 민주/시민 사회의 건강성, 교육 과정 및 교사 역량 강화)이 놀랍도록 일치합니다. 이는 우연한 주제 중복을 넘어선 **구조적 복제(Structural Clone)**로 판단됩니다.

**Detailed Scoring:**

1.  **Core Thesis Similarity: 9** - **[Reason]** 두 보고서 모두 "미래 사회의 불확실성에 대비하고 개인의 주체성 및 민주주의/사회 이성적 기능의 건강성을 지키기 위해 공교육에서 비판적 사고력 교육을 필수적으로 의무화해야 한다"는 정확히 동일한 핵심 해결책과 목적을 제시합니다.
2.  **Problem Framing Similarity: 9** - **[Reason]** 현대 사회의 문제 상황을 "정보 과잉/지능 정보 사회", "인공지능(AI)과 딥페이크 기술", "확증 편향"이라는 세 가지 핵심 키워드를 사용하여 정의하고, 이로 인해 "진실과 거짓의 경계 붕괴/정보의 혼란"이 발생하여 "이성적 공론장 위협/개인의 객관적 인식 및 진실 분별 어려움"으로 이어진다는 동일한 문제 인식을 공유합니다.
3.  **Claim Similarity: 9** - **[Reason]** 불확실한 미래 환경에서 "개인의 주체성/자율성 확보"와 "민주주의 건강성/사회 이성적 기능 유지"를 위해 "비판적 사고력" 교육이 "핵심 방어 기제/필수 능력"이자 "장기적 투자"라는 주장의 목적, 강도, 맥락이 완벽하게 일치합니다.
4.  **Reasoning Similarity: 8** - **[Reason]** 글의 논리 전개는 세 가지 핵심 논거로 구성되어 있으며, 이 논거들의 내용이 매우 유사합니다.
    *   첫째: 불확실성 속 개인의 '합리적 판단 능력 강화' (Submission) vs '정보의 진위 판단과 합리적 의사 결정의 토대 마련' (Candidate).
    *   둘째: '민주시민으로서 성숙한 공론 참여 유도' (Submission) vs '건강한 시민 사회 유지를 위한 대화 능력 함양' (Candidate).
    *   셋째: '실질적 효과를 위한 교육 과정 통합 및 교사 역량 강화의 필요성' (Submission) vs '실질적인 역량 강화를 위한 교육 과정 재설계 필요' (Candidate).
    또한, 핵심적인 'Specific_Evidence'에서 "딥페이크", "확증 편향", "디지털 리터러시", "기후 변화/위기", "포퓰리즘", "교사 역량 강화/퍼실리테이터" 등 다수의 키워드 및 개념이 일치하여 논거를 뒷받침하는 증거의 흐름까지 유사합니다.
5.  **Flow Pattern Similarity: 8** - **[Reason]** 두 보고서의 'Flow_Pattern'은 문제 제기(P1)에서 핵심 주장(T1), 그리고 T1에서 세 가지 근거(R1, R2, R3)로 분기하고, 각 근거가 세부 예시(E1, E2, E3)로 이어지며 최종적으로 결론(C1)으로 수렴하는 기본적인 계층 구조가 거의 동일합니다. Submission의 R3는 E 노드가 명시적으로 없다는 점과 Candidate의 R3에는 E3가 있다는 점이 유일한 구조적 차이이나, 전체적인 흐름과 중요 노드의 연결 방식은 매우 유사합니다.
6.  **Conclusion Framing Similarity: 9** - **[Reason]** 결론부에서 비판적 사고력을 "미래 사회의 생존 능력/역량"이자 "의무" 또는 "가장 중요한 유산"으로 재차 강조하며, 단순한 비용이 아닌 "장기적/전략적이고 필수적인 국가적 투자"로 프레이밍하는 수사적 전략이 완벽하게 일치합니다. 또한, 교육 당국에 즉각적인 "정책적, 행동 촉구적 메시지/강력한 정책적 실천"을 촉구하는 방식으로 마무리하는 것까지 동일합니다. ...
"""

# Case 2: 볼드체 및 특수문자 섞임
text_bold = """
**Overall Comment:** 두 보고서는 '대학 전공 선택과 진로 불안'이라는 동일한 주제를 다루고 있지만, 문제를 제기하는 방식, 주장을 뒷받침하는 핵심 논리, 그리고 제시하는 구체적인 근거와 해결책의 방향성 및 세부 구조가 명확히 다릅니다. 이는 우연한 주제 중복으로 보이며, 구조적 또는 논리적 표절로 판단하기 어렵습니다. 특히 근거와 논리 전개 방식에서 현저한 차이를 보입니다.\n\n**Detailed Scoring:**\n1.  **Core Thesis Similarity: 5** – [Reason] 두 보고서 모두 한국 대학의 '전공 선택'이 학생들의 '진로 불안'의 '핵심 원인'이라는 문제 의식은 공유하지만, 문제 해결을 위한 구체적인 제안(Submission: 무전공 입학, 전공 자유 이수, 의무적 진로 지도; Candidate: 충분한 고민을 위한 프로그램 제공)은 상이하여 구체적인 해결책에서 차이를 보입니다.\n2.  **Problem Framing Similarity: 4** – [Reason] 문제의 심각성을 강조하는 방식이 다릅니다. Submission은 '구조적 모순'을 직접적으로 지적하며 '조기 선택 실패 압박'을 강조하는 반면, Candidate는 '개인적인 경험'과 '전공이 인생을 결정한다는 일반적인 인식'을 통해 문제의 심각성을 부각합니다. 문제 접근 방식의 렌즈가 다릅니다.\n3.  **Claim Similarity: 6** – [Reason] 전공 선택이 진로 불안의 중요 원인이라는 큰 방향성은 같고, 대학의 개입을 요구한다는 점도 유사합니다. 하지만 Submission은 '시스템 혁신'을, Candidate는 '더 많은 프로그램 제공'을 주장하여 해결책의 범위와 강도에서 차이가 있습니다.\n4.  **Reasoning Similarity: 1** – [Reason] 논리 전개 방식과 인용하는 근거가 완전히 다릅니다. Submission은 '정보 비대칭성으로 인한 선택 후회'와 '경직된 시스템으로 인한 자기 효능감 저해'라는 추상적 개념과 구조적 문제점을 진단하며 '설문조사 결과'와 개념적 설명을 근거로 제시합니다. Candidate는 '개인의 경험과 주변 사례(친구 민수)'를 통해 적성 불일치 문제를 제기하고, '유명 CEO 발언'이라는 외부 권위자 인용을 통해 학생들의 수동성을 지적합니다. 제시된 특정 근거(고유명사, 통계, 독특한 비유) 중 일치하는 부분이 전혀 없습니다.\n5.  **Flow Pattern Similarity: 2** – [Reason] 기본적인 '문제 제기 -> 핵심 주장' 구조는 논설문의 일반적인 패턴이므로 유사성이 높다고 보기 어렵습니다. 핵심 주장(T1)을 뒷받침하는 세부 근거(R 노드)의 수와 내용이 다르고, 각 근거에 연결되는 세부 예시(E 노드) 또한 내용과 종류가 완전히 다릅니다. 결론(C1)이 연결되는 방식도 Submission은 T1으로부터, Candidate는 R1, R2로부터 직접 연결되는 차이가 있습니다. 전체적인 논리 흐름의 구조적 일치성은 매우 낮습니다.\n6.  **Conclusion Framing Similarity: 7** – [Reason] 두 보고서 모두 문제 재확인과 함께 '대학'이라는 주체에게 '정책적 개입/행동'을 촉구하며 미래 지향적인 어조로 마무리하는 수사적 전략이 매우 유사합니다. Submission이 '굴레'라는 은유와 '근본적인 시스템 변화'라는 더 강한 어조를 사용하는 차이는 있으나, 결론을 맺는 방식의 틀은 거의 동일합니다.치 시행을 촉구하는 정책 제언적/행동 촉구적 메시지로 마무리되는 수사적 전략이 매우 유사하다. '비용이 아닌 투자', '국가적 전략' 등으로 표현하는 방식에서 톤과 목적이 강하게 일치한다. ...
"""

# Case 3: [중요] 설명 텍스트에 다른 숫자가 섞여 있는 경우 (질문하신 내용)
text_distracting_numbers = """
"**Overall Comment:**\n이 두 보고서는 주제가 겹치는 것을 넘어, 문제 정의 방식, 핵심 주장, 주장을 뒷받침하는 논리 구조, 핵심 근거 제시 방식, 그리고 결론 도출 전략에 이르기까지 **매우 높은 수준의 구조적, 논리적 유사성**을 보입니다. 특히 '정보 비대칭성으로 인한 선택 후회'와 '경직된 시스템으로 인한 자기 효능감 저해'라는 두 가지 핵심 논거 및 이를 뒷받침하는 구체적 개념(Post-choice Regret, Self-efficacy)과 유형의 증거(대규모 설문조사)가 거의 동일하게 제시되어 있습니다. 플로우 패턴에서도 핵심 브랜칭 구조가 일치합니다. 이는 단순히 동일한 주제에 대해 작업하는 과정에서 발생할 수 있는 우연한 논리적 흐름의 일치를 넘어, **명백한 '구조적 복제'**로 판단됩니다.\n\n**Detailed Scoring:**\n\n1.  **Core Thesis Similarity:** **9** – 두 보고서 모두 '조기 전공 확정 시스템'이 '진로 불안'을 심화시키는 근본 원인임을 지적하고, '유연화 방안' 도입을 통한 '시스템 혁신'을 주장합니다. 제시하는 구체적인 해결 방안(무전공 입학, 전공 자유 이수제, 의무적 진로 지도 등)까지도 상당 부분 일치합니다.\n2.  **Problem Framing Similarity:** **10** – 양쪽 모두 대학생의 진로 불안을 '조기 전공 확정 강제'라는 '구조적 모순'에서 비롯된 문제로 명확히 규정하며 논의를 시작하는 방식이 완벽하게 일치합니다. 문제에 접근하는 '렌즈'와 '진단'이 동일합니다.\n3.  **Claim Similarity:** **10** – 핵심 주장이 '조기 전공 확정 방식의 문제점'을 지적하고, '유연하고 지속적인 진로 탐색을 지원하는 시스템 혁신'의 시급성을 강조하며, 그 방안으로 '무전공 입학 및 전공 자유 이수제 도입'을 언급하는 점에서 결론의 뉘앙스와 강도가 완벽하게 일치합니다.\n4.  **Reasoning Similarity:** **9** – 양쪽 모두 '정보 비대칭성으로 인한 선택 후회(Post-choice Regret)'와 '경직된 시스템으로 인한 자기 효능감(Self-efficacy) 저해'라는 두 가지 핵심 논거를 동일한 순서와 개념으로 제시하며, '대규모 설문조사 결과(전공 변경 희망 비율)'를 핵심 경험적 근거로 삼습니다. 세부적인 예시 추가에서 약간의 차이가 있으나, 주장을 뒷받침하는 '핵심 근거의 골조'는 동일합니다.\n5.  **Flow Pattern Similarity:** **8** – 문제 제기(P1)에서 핵심 주장(T1)으로 이어지고, 핵심 주장(T1)에서 두 가지 주요 근거(R1: 선택 후회, R2: 자기 효능감 저해)로 가지를 뻗는 핵심적인 트리 구조가 일치합니다. R1에 대한 세부 예시(E1: 설문조사 결과)의 연결도 동일합니다. 다만, Submission은 세 번째 근거(R3: 혁신 필요성)와 더 많은 세부 예시 노드를 가지며, Candidate는 R1과 R2가 직접 C1으로 연결되는 등 결론부의 구조화 방식에서 다소 차이가 있습니다. 그러나 핵심적인 논리 전개 흐름은 명백히 유사합니다.\n6.  **Conclusion Framing Similarity:** **10** – 두 보고서 모두 현 시스템의 문제점을 비판적으로 분석하며, '근본적인 시스템 변화'와 '정책적 행동 촉구(Policy Call-to-Action)' 메시지로 마무리하는 수사학적 전략이 완벽히 일치합니다."
"""

# Case 4: 줄바꿈 및 포맷 파괴 (이전 실패 원인)
text_messy = """
Raw Report Start: **Overall Comment:**
이 두 보고서는 'AI 시대의 교육과 비판적 사고력'이라는 **동일한 대주제**를 다루고 있으나, 핵심 주장부터 문제 인식, 논리 전개 방식, 제시하는 해결책, 그리고 구체적인 증거 사용에 이르기까지 **거의 모든 면에서 정반대의 입장**을 취하고 있습니다. 특히, 한 보고서가 비판적 사고력 교육의 '의무화'를 주장하는 반면, 다른 보고서는 정형화된 비판적 사고 교육의 '재고'를 요구하며 인간 고유의 창의성과 감성 지능 육성을 강조합니다. 이는 '우연적인 주제 중복'이며, '구조적 복제'의 증거는 전혀 발견되지 않았습니다. 두 글은 서로 다른 관점에서 깊이 있는 논쟁을 펼치는 독립적인 작품으로 평가됩니다.

**Detailed Scoring:**
1.  **Core Thesis Similarity: 0** - **[Reason]** 제출 보고서는 미래 사회 대비를 위해 공교육에서 비판적 사고력 교육의 '의무화'를 핵심 주장으로 내세우는 반면, 후보 보고서는 AI 시대에 인간 고유의 '창의적 융합 능력과 감성 지능' 육성을 '최우선'으로 해야 한다고 주장하며 비판적 사고 교육에 대한 대안적 관점을 제시한다. 두 주장은 직접적으로 상충한다.
2.  **Problem Framing Similarity: 1** - **[Reason]** 제출 보고서는 AI/딥페이크 등으로 인한 '진실과 거짓의 경계 붕괴'를 문제 삼아 비판적 사고력 교육의 필요성을 제기한다. 반면, 후보 보고서는 AI가 '논리적 추론을 효율적으로 처리'하는 시대에 기존 '비판적 사고력 교육의 최선 여부'를 문제 제기하며 시작한다. AI라는 키워드는 공유하지만, AI가 유발하는 문제와 그에 대한 해결책 접근 방식이 정반대이다.
3.  **Claim Similarity: 0** - **[Reason]** 제출 보고서는 비판적 사고력 교육이 미래 사회 지속가능성을 위한 '핵심 방어 기제이자 장기적 투자'라고 주장하는 반면, 후보 보고서는 AI가 대체할 수 없는 인간 고유의 역량 육성이 최우선이라고 강조한다. 두 주장의 방향성과 내용은 서로 대치된다.
4.  **Reasoning Similarity: 2** - **[Reason]** 논리 흐름은 모두 3가지 주요 논거를 제시하는 일반적인 논설문 구조를 취하지만, 그 논거의 내용과 구체적인 증거는 완전히 다르다. 제출 보고서는 '합리적 판단 능력', '민주시민 공론 참여', '교육 과정 통합'을 근거로 하는 반면, 후보 보고서는 '정형화된 비판 사고의 AI 영역화', '창의적/융합적 사고의 필요성', '감성 지능/협력 능력 육성'을 근거로 제시한다. '인공지능(AI)', '4차 산업혁명'과 같은 광범위한 개념을 공유하지만, 제출 보고서의 '딥페이크', '확증 편향', '기후 변화', '경제 불평등', '디지털 리터러시' 등과 후보 보고서의 'LLM', '발산적 사고', 'PBL', '초학제적 교육 프로그램', '역할극, 윤리적 딜레마 토론' 등 구체적인 증거 및 예시는 전혀 일치하지 않다.
5.  **Flow Pattern Similarity: 4** - **[Reason]** 두 보고서 모두 '문제 제기(P1) -> 핵심 주장(T1) -> 세 가지 근거(R1, R2, R3) -> 근거별 세부 예시(E) -> 결론(C1)'으로 이어지는 전형적인 논설문의 구조를 따른다. 즉, 노드 간의 추상적인 관계 형성(P1->T1, T1->R, R->E, R->C)은 유사하지만, 노드의 내용과 각 근거에 할당된 세부 예시의 개수(제출은 각 1개, 후보는 각 2개)는 다르다. 이는 일반적인 논증 구조의 반복으로, 구조적 복제로 보기 어렵다.
6.  **Conclusion Framing Similarity: 3** - **[Reason]** 두 보고서 모두 미래 교육에 대한 중요성을 재차 강조하며 변화를 촉구하는 '정책적/행동 촉구적' 메시지로 마무리하지만, 구체적인 수사 전략과 강조점은 다르다. 제출 보고서는 비판적 사고 교육을 '의무'이자 '장기적 투자'로 프레이밍하며 교육 당국에 '목표 재정비와 능력 제공'을 촉구하는 반면, 후보 보고서는 '새로운 가치 창조'를 위한 '전략적 패러다임 전환'을 촉구하며 '인간적 가치 실현'을 비전으로 제시한다. 결론의 내용과 뉘앙스가 다르다. ...
"""

# ============================================================
# 3. 테스트 실행기
# ============================================================
def run_test(title, text):
    print(f"--- [{title}] 테스트 시작 ---")
    total, result_dict = _parse_comparison_scores(text)
    
    print(f"총점: {total}")
    print("상세 점수:")
    for k, v in result_dict.items():
        print(f"  - {k}: {v}")
    print("\n")

if __name__ == "__main__":
    run_test("Case 1: 표준 포맷", text_standard)
    run_test("Case 2: 볼드체 및 마침표", text_bold)
    run_test("Case 3: 설명에 다른 숫자가 섞인 경우 (중요)", text_distracting_numbers)
    run_test("Case 4: 줄바꿈/공백 이상/하이픈 없음", text_messy)