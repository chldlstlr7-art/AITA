import re

# ============================================================
# 1. 테스트 대상 함수 (개선된 버전)
# ============================================================
def _parse_comparison_scores(report_text):
    scores = {
        "Core Thesis Similarity": 0, "Problem Framing Similarity": 0, "Claim Similarity": 0,
        "Reasoning Similarity": 0, "Flow Pattern Similarity": 0, "Conclusion Framing Similarity": 0,
    }
    
    try:
        for key_name in scores.keys():
            # [핵심 정규식]
            # 1. 키 이름 매칭
            # 2. 콜론(:) 매칭
            # 3. (**)? 볼드 무시
            # 4. (\d+) 숫자 추출 -> 여기서 매칭 종료! 뒤에 뭐가 오든 상관없음
            pattern = rf"{re.escape(key_name)}\s*:\s*(?:\*\*)?(\d+)"
            
            match = re.search(pattern, report_text, re.IGNORECASE)
            if match:
                scores[key_name] = int(match.group(1))
            else:
                # 테스트를 위해 못 찾으면 경고 출력
                print(f"   [Warning] '{key_name}' 점수 찾기 실패")

        final_score = sum(scores.values())

    except Exception as e:
        print(f"   [Error] 파싱 중 에러: {e}")
        return 0, scores
    
    return final_score, scores

# ============================================================
# 2. 테스트 케이스 정의
# ============================================================

# Case 1: 표준 포맷 (하이픈 포함)
text_standard = """
이 두 보고서는 단순히 유사한 주제를 다루는 것을 넘어, 문제 정의, 핵심 주장, 주장을 뒷받침하는 세 가지 주요 논거의 전개 방식, 그리고 결론부의 수사적 전략에 이르기까지 **거의 동일한 논리적 건축물**을 공유하고 있습니다. 특히 문제 상황을 설명하는 핵심 개념들("딥페이크", "확증 편향")과 비판적 사고력 교육의 효과를 설명하는 논거들(개인의 합리적 판단 능력, 민주/시민 사회의 건강성, 교육 과정 및 교사 역량 강화)이 놀랍도록 일치합니다. 이는 우연한 주제 중복을 넘어선 **구조적 복제(Structural Clone)**로 판단됩니다.

**Detailed Scoring:**

1.  **Core Thesis Similarity: 9** - **[Reason]** 두 보고서 모두 "미래 사회의 불확실성에 대비하고 개인의 주체성 및 민주주의/사회 이성적 기능의 건강성을 지키기 위해 공교육에서 비판적 사고력 교육을 필수적으로 의무화해야 한다"는 정확히 동일한 핵심 해결책과 목적을 제시합니다.
2.  **Problem Framing Similarity: 9** - **[Reason]** 현대 사회의 문제 상황을 "정보 과잉/지능 정보 사회", "인공지능(AI)과 딥페이크 기술", "확증 편향"이라는 세 가지 핵심 키워드를 사용하여 정의하고, 이로 인해 "진실과 거짓의 경계 붕괴/정보의 혼란"이 발생하여 "이성적 공론장 위협/개인의 객관적 인식 및 진실 분별 어려움"으로 이어진다는 동일한 문제 인식을 공유합니다.
3.  **Claim Similarity: 9** - **[Reason]** 불확실한 미래 환경에서 "개인의 주체성/자율성 확보"와 "민주주의 건강성/사회 이성적 기능 유지"를 위해 "비판적 사고력" 교육이 "핵심 방어 기제/필수 능력"이자 "장기적 투자"라는 주장의 목적, 강도, 맥락이 완벽하게 일치합니다.
4.  **Reasoning Similarity: 8** - **[Reason]** 글의 논리 전개는 세 가지 핵심 논거로 구성되어 있으며, 이 논거들의 내용이 매우 유사합니다.
    *   첫째: 불확실성 속 개인의 '합리적 판단 능력 강화' (Submission) vs '정보의 진위 판단과 합리적 의사 결정의 토대 마련' (Candidate).
    *   둘째: '민주시민으로서 성숙한 공론 참여 유도' (Submission) vs '건강한 시민 사회 유지를 위한 대화 능력 함양' (Candidate).
    *   셋째: '실질적 효과를 위한 교육 과정 통합 및 교사 역량 강화의 필요성' (Submission) vs '실질적인 역량 강화를 위한 교육 과정 재설계 필요' (Candidate).
    또한, 핵심적인 'Specific_Evidence'에서 "딥페이크", "확증 편향", "디지털 리터러시", "기후 변화/위기", "포퓰리즘", "교사 역량 강화/퍼실리테이터" 등 다수의 키워드 및 개념이 일치하여 논거를 뒷받침하는 증거의 흐름까지 유사합니다.
5.  **Flow Pattern Similarity: 8** - **[Reason]** 두 보고서의 'Flow_Pattern'은 문제 제기(P1)에서 핵심 주장(T1), 그리고 T1에서 세 가지 근거(R1, R2, R3)로 분기하고, 각 근거가 세부 예시(E1, E2, E3)로 이어지며 최종적으로 결론(C1)으로 수렴하는 기본적인 계층 구조가 거의 동일합니다. Submission의 R3는 E 노드가 명시적으로 없다는 점과 Candidate의 R3에는 E3가 있다는 점이 유일한 구조적 차이이나, 전체적인 흐름과 중요 노드의 연결 방식은 매우 유사합니다.
6.  **Conclusion Framing Similarity: 9** - **[Reason]** 결론부에서 비판적 사고력을 "미래 사회의 생존 능력/역량"이자 "의무" 또는 "가장 중요한 유산"으로 재차 강조하며, 단순한 비용이 아닌 "장기적/전략적이고 필수적인 국가적 투자"로 프레이밍하는 수사적 전략이 완벽하게 일치합니다. 또한, 교육 당국에 즉각적인 "정책적, 행동 촉구적 메시지/강력한 정책적 실천"을 촉구하는 방식으로 마무리하는 것까지 동일합니다. ...
"""

# Case 2: 볼드체 및 특수문자 섞임
text_bold = """
각 근거를 뒷받침하는 구체적인 사례(Specific_Evidence)는 매우 다르다.** Submission은 주로 민주주의의 건강성, 공론장의 위협, 정보 과잉에 초점을 맞추는 반면, Candidate는 직업적 생존력, 기술 윤리, 심리적 회복탄력성에 집중한다.

이는 단순히 우연한 주제 중복이 아니라, **특정 논증의 구조적 틀(skeleton)을 차용하여 동일한 논리적 흐름 위에 다른 내용(meat)을 채워 넣은 '구조적 복제' 또는 '템플릿 차용'의 강력한 의심이 드는 경우이다.** 특정 단어나 문장을 직접적으로 표절하지 않았음에도 불구하고, 논문의 설계도가 거의 같다는 점에서 높은 수준의 구조적/논리적 유사성 점수를 부여한다. 핵심 주장(T1)에서 세 개의 독립적인 근거(R1, R2, R3)로 분기하고, 이들이 다시 결론(C1)으로 수렴하는 논리적 패턴은 흔하지만, 세부적인 연결 구조까지 동일하다는 것은 우연으로 보기 어렵다.

**Detailed Scoring:**

1.  **Core Thesis Similarity: 6** - 두 논문 모두 '공교육에서 비판적 사고력 교육을 필수적으로 의무화해야 한다'는 동일한 핵심 해결책을 제시한다. 그러나 그 필요성을 제기하는 구체적인 목표(Submission: 개인 주체성 및 민주주의 건강성; Candidate: 직업적 생존력 및 사회 윤리적 안정성)에 약간의 차이가 있어 '정확히 동일한' 해결책으로 보기에는 미묘한 차이가 있다.
2.  **Problem Framing Similarity: 3** - 문제 제기 방식이 확연히 다르다. Submission은 정보 과잉, AI/딥페이크, 확증 편향, 이성적 공론장 위협 등 주로 사회적/인지적/윤리적 측면에서 문제를 제시하는 반면, Candidate는 '지식 반감기'와 '기술적 실업' 등 경제적/직업적 측면에서 문제를 제기한다. 문제의 렌즈가 다르다.
3.  **Claim Similarity: 7** - 두 논문 모두 '미래 사회의 불확실성에 대비하고 지속가능성을 위해 비판적 사고 교육을 의무화해야 한다'는 핵심 주장의 방향과 강도가 매우 유사하다. Submission은 '핵심 방어 기제이자 장기적 투자'로, Candidate는 '불확실성 시대 돌파 및 지속 가능한 번영'으로 표현하며 디테일은 다르지만 핵심 메시지는 거의 일치한다.
4.  **Reasoning Similarity: 2** - **[CRITICAL]** 주장의 핵심 논거와 이를 뒷받침하는 구체적인 증거들이 거의 일치하지 않는다.
    *   Submission의 논거: 합리적 판단 능력 강화, 민주시민 공론 참여 유도, 교육 과정/교사 역량 강화. (증거: 딥페이크, 확증 편향, 디지털 리터러시, 혐오 표현 등)
    *   Candidate의 논거: 직업적 유연성 확보, 첨단 기술 윤리 문제 해결, 심리적 회복탄력성 증진. (증거: 지식 반감기, 기술적 실업, 자율 주행차 윤리, 공리주의/의무론, 감정적 편향 등)
    두 보고서 모두 '인공지능(AI)', 'SNS'와 같은 일반적인 용어를 언급하지만, 그 맥락과 구체적인 예시(고유명사, 통계, 독특한 은유 등)는 완전히 다르다. 핵심 논거 자체가 다르기 때문에 점수가 매우 낮다.
5.  **Flow Pattern Similarity: 9** - **논문의 논리적 흐름과 구조가 거의 동일하다.** P1(문제 제기)에서 T1(핵심 주장)으로 이어지고, T1이 R1, R2, R3(세 가지 핵심 근거)로 분기하며, 각 R이 E(세부 예시)로 뒷받침되고, 최종적으로 모든 R이 C1(결론)으로 수렴하는 전체적인 트리 구조가 놀랍도록 일치한다. 노드의 내용 자체는 다르지만, 노드 간의 관계와 배열 방식은 사실상 복제되었다고 볼 수 있다.
6.  **Conclusion Framing Similarity: 8** - 결론 부분이 비판적 사고력의 중요성을 재차 강조하며, 교육 당국에 즉각적인 조치 시행을 촉구하는 정책 제언적/행동 촉구적 메시지로 마무리되는 수사적 전략이 매우 유사하다. '비용이 아닌 투자', '국가적 전략' 등으로 표현하는 방식에서 톤과 목적이 강하게 일치한다. ...
"""

# Case 3: [중요] 설명 텍스트에 다른 숫자가 섞여 있는 경우 (질문하신 내용)
text_distracting_numbers = """
1. Core Thesis Similarity: 5 - 이 문서는 2024년 자료와 100% 일치함.
2. Problem Framing Similarity: 6 - 예시가 3가지나 있음.
3. Claim Similarity: 4 - 1번과 2번 근거가 다름.
4. Reasoning Similarity: 7 - 50% 정도 유사함.
5. Flow Pattern Similarity: 8 - 10단계 중 8단계가 같음.
6. Conclusion Framing Similarity: 9 - 1990년대 자료 인용.
"""

# Case 4: 줄바꿈 및 포맷 파괴 (이전 실패 원인)
text_messy = """
Raw Report Start: **Overall Comment:**
이 두 보고서는 'AI 시대의 교육과 비판적 사고력'이라는 **동일한 대주제**를 다루고 있으나, 핵심 주장부터 문제 인식, 논리 전개 방식, 제시하는 해결책, 그리고 구체적인 증거 사용에 이르기까지 **거의 모든 면에서 정반대의 입장**을 취하고 있습니다. 특히, 한 보고서가 비판적 사고력 교육의 '의무화'를 주장하는 반면, 다른 보고서는 정형화된 비판적 사고 교육의 '재고'를 요구하며 인간 고유의 창의성과 감성 지능 육성을 강조합니다. 이는 '우연적인 주제 중복'이며, '구조적 복제'의 증거는 전혀 발견되지 않았습니다. 두 글은 서로 다른 관점에서 깊이 있는 논쟁을 펼치는 독립적인 작품으로 평가됩니다.

**Detailed Scoring:**
1.  **Core Thesis Similarity: 0** - **[Reason]** 제출 보고서는 미래 사회 대비를 위해 공교육에서 비판적 사고력 교육의 '의무화'를 핵심 주장으로 내세우는 반면, 후보 보고서는 AI 시대에 인간 고유의 '창의적 융합 능력과 감성 지능' 육성을 '최우선'으로 해야 한다고 주장하며 비판적 사고 교육에 대한 대안적 관점을 제시한다. 두 주장은 직접적으로 상충한다.
2.  **Problem Framing Similarity: 1** - **[Reason]** 제출 보고서는 AI/딥페이크 등으로 인한 '진실과 거짓의 경계 붕괴'를 문제 삼아 비판적 사고력 교육의 필요성을 제기한다. 반면, 후보 보고서는 AI가 '논리적 추론을 효율적으로 처리'하는 시대에 기존 '비판적 사고력 교육의 최선 여부'를 문제 제기하며 시작한다. AI라는 키워드는 공유하지만, AI가 유발하는 문제와 그에 대한 해결책 접근 방식이 정반대이다.
3.  **Claim Similarity: 0** - **[Reason]** 제출 보고서는 비판적 사고력 교육이 미래 사회 지속가능성을 위한 '핵심 방어 기제이자 장기적 투자'라고 주장하는 반면, 후보 보고서는 AI가 대체할 수 없는 인간 고유의 역량 육성이 최우선이라고 강조한다. 두 주장의 방향성과 내용은 서로 대치된다.
4.  **Reasoning Similarity: 2** - **[Reason]** 논리 흐름은 모두 3가지 주요 논거를 제시하는 일반적인 논설문 구조를 취하지만, 그 논거의 내용과 구체적인 증거는 완전히 다르다. 제출 보고서는 '합리적 판단 능력', '민주시민 공론 참여', '교육 과정 통합'을 근거로 하는 반면, 후보 보고서는 '정형화된 비판 사고의 AI 영역화', '창의적/융합적 사고의 필요성', '감성 지능/협력 능력 육성'을 근거로 제시한다. '인공지능(AI)', '4차 산업혁명'과 같은 광범위한 개념을 공유하지만, 제출 보고서의 '딥페이크', '확증 편향', '기후 변화', '경제 불평등', '디지털 리터러시' 등과 후보 보고서의 'LLM', '발산적 사고', 'PBL', '초학제적 교육 프로그램', '역할극, 윤리적 딜레마 토론' 등 구체적인 증거 및 예시는 전혀 일치하지 않다.
5.  **Flow Pattern Similarity: 4** - **[Reason]** 두 보고서 모두 '문제 제기(P1) -> 핵심 주장(T1) -> 세 가지 근거(R1, R2, R3) -> 근거별 세부 예시(E) -> 결론(C1)'으로 이어지는 전형적인 논설문의 구조를 따른다. 즉, 노드 간의 추상적인 관계 형성(P1->T1, T1->R, R->E, R->C)은 유사하지만, 노드의 내용과 각 근거에 할당된 세부 예시의 개수(제출은 각 1개, 후보는 각 2개)는 다르다. 이는 일반적인 논증 구조의 반복으로, 구조적 복제로 보기 어렵다.
6.  **Conclusion Framing Similarity: 3** - **[Reason]** 두 보고서 모두 미래 교육에 대한 중요성을 재차 강조하며 변화를 촉구하는 '정책적/행동 촉구적' 메시지로 마무리하지만, 구체적인 수사 전략과 강조점은 다르다. 제출 보고서는 비판적 사고 교육을 '의무'이자 '장기적 투자'로 프레이밍하며 교육 당국에 '목표 재정비와 능력 제공'을 촉구하는 반면, 후보 보고서는 '새로운 가치 창조'를 위한 '전략적 패러다임 전환'을 촉구하며 '인간적 가치 실현'을 비전으로 제시한다. 결론의 내용과 뉘앙스가 다르다. ...
"""

# ============================================================
# 3. 테스트 실행기
# ============================================================
def run_test(title, text):
    print(f"--- [{title}] 테스트 시작 ---")
    total, result_dict = _parse_comparison_scores(text)
    
    print(f"총점: {total}")
    print("상세 점수:")
    for k, v in result_dict.items():
        print(f"  - {k}: {v}")
    print("\n")

if __name__ == "__main__":
    run_test("Case 1: 표준 포맷", text_standard)
    run_test("Case 2: 볼드체 및 마침표", text_bold)
    run_test("Case 3: 설명에 다른 숫자가 섞인 경우 (중요)", text_distracting_numbers)
    run_test("Case 4: 줄바꿈/공백 이상/하이픈 없음", text_messy)